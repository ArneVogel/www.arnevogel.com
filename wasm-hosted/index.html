<!doctype html><html lang=en><head><title>WebAssembly hosted Web Server</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Arne Vogel"><meta name=description content><meta property="og:url" content="https://www.arnevogel.com/wasm-hosted/"><meta property="og:title" content="WebAssembly hosted Web Server"><link rel=canonical href=https://www.arnevogel.com/wasm-hosted/><link rel=icon type=image/png href=https://www.arnevogel.com/favicon.png sizes=128x128><link href=https://www.arnevogel.com/style/style.css rel=stylesheet><link href=https://www.arnevogel.com//css/syntax.css rel=stylesheet></head><body><header class=site-header><div class=wrapper><a href=/ class=header-text>Arne Vogel</a><br></div></header><div class=site-content><div class=wrapper><h1>WebAssembly hosted Web Server</h1><span class=list-date>Aug 1, 2022 • Arne Vogel</span><p>We can now host web servers as WebAssembly modules!</p><p>As a proof of concept see <a href=https://wasmhosted.arnevogel.com>wasmhosted.arnevogel.com</a>, which is hosted by a WebAssembly module run by wasmtime.
Also check out the <a href=https://github.com/arnevogel/wasm-file-server>source code</a>.</p><h2 id=how-we-got-here>How we got here</h2><p>This year, <code>sock_accept</code> was <a href=https://github.com/WebAssembly/WASI/pull/458>added to WASI</a>.
Because of this, we can now accept connections on pre-opened listening sockets from within WebAssembly.
Before <code>sock_accept</code> only <code>sock_recv</code>, <code>sock_send</code>, and <code>sock_shutdown</code> were <a href=https://github.com/WebAssembly/WASI/blob/71e710bfa88fa460963ad465dcdc548e4542fae2/phases/snapshot/witx/wasi_snapshot_preview1.witx#L487>defined for WASI</a>.
Unfortunately, you can&rsquo;t do much with the three of them alone.</p><p>That&rsquo;s why <code>sock_accept</code> is so exciting.
Support for <code>sock_accept</code> has in the meanwhile been added for the Rust <a href=https://github.com/rust-lang/rust/pull/93158>stdlib</a>, <a href=https://github.com/tokio-rs/tokio/pull/4716>tokio + mio</a>, and probably a lot more places.</p><h2 id=accepting-connections>Accepting connections</h2><p>We can only accept connections on pre-opened listening sockets.
This means for our WebAssembly module that we cannot open a socket from inside the module.
We have to get the socket from the runtime.
Fortunately <a href=https://github.com/bytecodealliance/wasmtime/commit/853a025613e012c6c29002ddcccfced67073a8d0>wasmtime already supports this</a>.</p><p>For us, this means that we have to construct our <code>TcpListener</code> from a raw file descriptor given to us by wasmtime:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=cp>#[cfg(target_os = </span><span class=s>&#34;wasi&#34;</span><span class=cp>)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>get_tcplistener</span><span class=p>()</span><span class=w> </span>-&gt; <span class=nc>TcpListener</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>os</span>::<span class=n>wasi</span>::<span class=n>io</span>::<span class=n>FromRawFd</span><span class=p>;</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>stdlistener</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>unsafe</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>std</span>::<span class=n>net</span>::<span class=n>TcpListener</span>::<span class=n>from_raw_fd</span><span class=p>(</span><span class=mi>4</span><span class=p>)</span><span class=w> </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>stdlistener</span><span class=p>.</span><span class=n>set_nonblocking</span><span class=p>(</span><span class=kc>true</span><span class=p>).</span><span class=n>unwrap</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>TcpListener</span>::<span class=n>from_std</span><span class=p>(</span><span class=n>stdlistener</span><span class=p>).</span><span class=n>unwrap</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></div><p>When we run our server with wasmtime we use <code>--tcplisten</code> to tell wasmtime to open up a socket listening on localhost:4000 and to provide this socket to our module.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>wasmtime run --tcplisten 127.0.0.1:4000 server.wasm</span></span></code></pre></div><p>Actually, for the proof of concept server I also need to specify the directory wasmtime lets the server access <code>--dir=public</code>, but thats besides the point.
While we are at it, we also need to <a href=https://github.com/ArneVogel/wasm-file-server/blob/main/socket.patch>patch</a> our wasmtime.
There has been an issue with wasmtime where <code>--tcplisten</code> and <code>--dir</code> do not play <a href=https://github.com/bytecodealliance/wasmtime/issues/3936>nicely together</a>.
The patch applies this &ldquo;<a href=https://github.com/bytecodealliance/wasmtime/issues/3936#issuecomment-1088393681>band-aid fix</a>&rdquo; to wasmtime to fix this issue.</p></div></div><footer class=site-footer><div class=wrapper>© Copyright - Arne Vogel<br>See <a href=/license/>License</a> for more details</div></footer></body></html>